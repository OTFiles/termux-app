name: Build Bootstraps with Proot

on:
  push:
    branches:
      - master
    paths:
      - '.github/workflows/build-bootstraps.yml'
      - 'scripts/setup-proot-bootstrap.sh'
  workflow_dispatch:

jobs:
  build-bootstraps:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [aarch64, arm, i686, x86_64]

    steps:
      - name: Checkout termux-app
        uses: actions/checkout@v4

      - name: Download official bootstrap
        run: |
          # 下载官方 bootstrap
          VERSION="2022.04.28-r5+apt-android-7"
          URL="https://github.com/termux/termux-packages/releases/download/bootstrap-${VERSION}/bootstrap-${{ matrix.arch }}.zip"
          
          echo "Downloading bootstrap from $URL"
          curl -L -o "bootstrap-${{ matrix.arch }}.zip" "$URL"
          
          if [ ! -f "bootstrap-${{ matrix.arch }}.zip" ]; then
            echo "Failed to download bootstrap"
            exit 1
          fi

      - name: Apply proot configuration to bootstrap
        run: |
          BOOTSTRAP_ZIP="bootstrap-${{ matrix.arch }}.zip"
          
          if [ -f "$BOOTSTRAP_ZIP" ]; then
            # 解压 bootstrap
            TEMP_DIR=$(mktemp -d)
            unzip -q "$BOOTSTRAP_ZIP" -d "$TEMP_DIR"
            
            # 替换硬编码路径 - 将 /data/data/com.termux/ 替换为 /data/data/com.readboy.termux/
            # 将 /data/user/0/com.termux/ 替换为 /data/data/com.readboy.termux/
            echo "Replacing hardcoded paths in bootstrap files..."
            find "$TEMP_DIR" -type f \( -name "*.sh" -o -name "*.bash" -o -name "*.conf" -o -name "*.list" -o -name "*.txt" -o -name "*.md" -o -name "*.properties" -o -name "*.tcsh" -o -name "*.awk" \) -exec sed -i 's|/data/data/com\.termux/|/data/data/com.readboy.termux/|g' {} \;
            find "$TEMP_DIR" -type f \( -name "*.sh" -o -name "*.bash" -o -name "*.conf" -o -name "*.list" -o -name "*.txt" -o -name "*.md" -o -name "*.properties" -o -name "*.tcsh" -o -name "*.awk" \) -exec sed -i 's|/data/user/0/com\.termux/|/data/data/com.readboy.termux/|g' {} \;
            echo "Path replacement completed"
            
            # 应用 proot 配置
            bash scripts/setup-proot-bootstrap.sh "$TEMP_DIR"
            
            # 重新打包
            cd "$TEMP_DIR"
            zip -qr "../bootstrap-${{ matrix.arch }}-proot.zip" .
            cd ..
            
            # 替换原始文件
            mv "bootstrap-${{ matrix.arch }}-proot.zip" "$BOOTSTRAP_ZIP"
            
            # 清理
            cd ..
            rm -rf "$TEMP_DIR"
            
            echo "Proot configuration applied to $BOOTSTRAP_ZIP"
          else
            echo "Error: Bootstrap zip not found"
            exit 1
          fi

      - name: Calculate checksum
        id: checksum
        run: |
          BOOTSTRAP_ZIP="bootstrap-${{ matrix.arch }}.zip"
          if [ -f "$BOOTSTRAP_ZIP" ]; then
            SHA256=$(sha256sum "$BOOTSTRAP_ZIP" | cut -d ' ' -f 1)
            echo "SHA256 for $BOOTSTRAP_ZIP: $SHA256"
            echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          fi

      - name: Upload bootstrap artifact
        uses: actions/upload-artifact@v4
        with:
          name: bootstrap-${{ matrix.arch }}
          path: bootstrap-${{ matrix.arch }}.zip
          retention-days: 30

  create-checksums:
    needs: build-bootstraps
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: bootstraps

      - name: Create checksums file
        run: |
          cd bootstraps
          find . -name "*.zip" -type f | sort | xargs sha256sum > bootstraps_sha256sums.txt
          cat bootstraps_sha256sums.txt

      - name: Upload checksums
        uses: actions/upload-artifact@v4
        with:
          name: bootstraps-checksums
          path: bootstraps/bootstraps_sha256sums.txt